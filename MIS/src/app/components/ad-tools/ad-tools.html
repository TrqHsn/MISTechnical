<div class="test-api-container">
  <h1>AD Tools</h1>

  <!-- Tab Navigation -->
  <div class="tabs">
    <button class="tab-btn" [class.active]="activeTab() === 'users'" (click)="activeTab.set('users')">
      Find User
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'computers'" (click)="activeTab.set('computers')">
      Find Computer
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'update-description'" (click)="activeTab.set('update-description')">
      Update Description
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'update-user'" (click)="activeTab.set('update-user')">
      Update User
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'last-device'" (click)="onTabChange('last-device')">
      Last Device
    </button>
  </div>

  <!-- Users Tab -->
  @if (activeTab() === 'users') {
  <div class="tab-content">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search users by name(single name), username, email..."
        [value]="usersSearchInput()" (input)="onUsersSearchInput($any($event).target.value)"
        (focus)="usersShowDropdown.set(true)" (keydown.enter)="onUsersSearchEnter()">

      <!-- Dropdown Results -->
      @if (usersShowDropdown() && (usersResults().length > 0 || usersLoading())) {
      <div class="dropdown">
        @if (usersLoading()) {
        <div class="loading">Loading...</div>
        }
        @for (user of usersResults(); track $index) {
        <div class="dropdown-item" (click)="selectUser(user)">
          <span class="item-text">{{ user['displayName'] || user['sAMAccountName'] || 'User' }}</span>
        </div>
        }
      </div>
      }
    </div>

    <!-- Selected User Card -->
    @if (selectedUser()) {
    <div class="result-card">
      <div class="card-header">
        <h3>User Details</h3>
        <button class="close-btn" (click)="clearUserSelection()">✕</button>
      </div>
      <div class="card-content">
        @for (key of getObjectKeys(selectedUser()); track key) {
        <div class="property-btn">
          <strong>{{ key }}:</strong>
          <span>{{ selectedUser()?.[key] }}</span>
          <button type="button" class="copy-btn" (click)="copyText(selectedUser()?.[key])">
            Copy
          </button>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }

  <!-- Computers Tab -->
  @if (activeTab() === 'computers') {
  <div class="tab-content">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search computers by host name, user name or description..."
        [value]="computersSearchInput()" (input)="onComputersSearchInput($any($event).target.value)"
        (focus)="computersShowDropdown.set(true)" (keydown.enter)="onComputersSearchEnter()">

      <!-- Dropdown Results -->
      @if (computersShowDropdown() && (computersResults().length > 0 || computersLoading())) {
      <div class="dropdown">
        @if (computersLoading()) {
        <div class="loading">Loading...</div>
        }
        @for (computer of computersResults(); track $index) {
        <div class="dropdown-item" (click)="selectComputer(computer)">
          <span class="item-text">{{ computer['description'] || computer['displayName'] || 'Computer' }}</span>
        </div>
        }
      </div>
      }
    </div>

    <!-- Selected Computer Card -->
    @if (selectedComputer()) {
    <div class="result-card">
      <div class="card-header">
        <h3>Computer Details</h3>
        <button class="close-btn" (click)="clearComputerSelection()">✕</button>
      </div>
      <div class="card-content">
        @for (key of getObjectKeys(selectedComputer()); track key) {
        <div class="property-btn">
          <strong>{{ key }}:</strong>
          <span>{{ selectedComputer()?.[key] }}</span>
          <button type="button" class="copy-btn" (click)="copyText(selectedComputer()?.[key])">
            Copy
          </button>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }

  <!-- Update Description Tab -->
  @if (activeTab() === 'update-description') {
  <div class="tab-content">
    <!-- Search Box 2: Source Computer (Copy From) -->
    <div class="search-container">
      <label class="search-label">Search Computer (Copy Description From)</label>
      <div class="search-row">
        <input type="text" class="search-input" placeholder="Search computers by name or description..."
          [value]="sourceComputerSearchInput()" (input)="onSourceComputerSearch($any($event).target.value)"
          (focus)="sourceComputerShowDropdown.set(true)" (keydown.enter)="onSourceComputerSearchEnter()">
        <button type="button" class="search-btn" (click)="triggerSourceSearch()">Search</button>
      </div>

      <!-- Dropdown Results -->
      @if (sourceComputerShowDropdown() && (sourceComputerResults().length > 0 || sourceComputerLoading())) {
      <div class="dropdown">
        @if (sourceComputerLoading()) {
        <div class="loading">Loading...</div>
        }
        @for (computer of sourceComputerResults(); track $index) {
        <div class="dropdown-item" (click)="selectSourceComputer(computer)">
          <span class="item-text">{{ computer['name'] || 'Computer' }}</span>
        </div>
        }
      </div>
      }
    </div>

    <!-- Selected Source Computer -->
    @if (selectedSourceComputer()) {
    <div class="selected-item">
      <span class="selected-text">Source: {{ selectedSourceComputer()?.['name'] }}</span>
      <button class="clear-btn" (click)="clearSourceComputer()">✕</button>
    </div>
    }

    <!-- Search Box 1: Target Computer (Update) -->
    <div class="search-container">
      <label class="search-label">Search Computer (Update Description For)</label>
      <div class="search-row">
        <input type="text" class="search-input" placeholder="Search computers by name or description..."
          [value]="targetComputerSearchInput()" (input)="onTargetComputerSearch($any($event).target.value)"
          (focus)="targetComputerShowDropdown.set(true)" (keydown.enter)="onTargetComputerSearchEnter()">
        <button type="button" class="search-btn" (click)="triggerTargetSearch()">Search</button>
      </div>

      <!-- Dropdown Results -->
      @if (targetComputerShowDropdown() && (targetComputerResults().length > 0 || targetComputerLoading())) {
      <div class="dropdown">
        @if (targetComputerLoading()) {
        <div class="loading">Loading...</div>
        }
        @for (computer of targetComputerResults(); track $index) {
        <div class="dropdown-item" (click)="selectTargetComputer(computer)">
          <span class="item-text">{{ computer['name'] || 'Computer' }}</span>
        </div>
        }
      </div>
      }
    </div>

    <!-- Selected Target Computer -->
    @if (selectedTargetComputer()) {
    <div class="selected-item">
      <span class="selected-text">Target: {{ selectedTargetComputer()?.['name'] }}</span>
      <span class="selected-text">Description: {{ selectedTargetComputer()?.['description'] }}</span>
      <button class="clear-btn" (click)="clearTargetComputer()">✕</button>
    </div>
    }

    <!-- Description Input Box -->
    <div class="description-section">
      <label class="description-label">Description</label>
      <textarea class="description-input" 
        [value]="descriptionInput()" 
        (input)="descriptionInput.set($any($event).target.value)"
        placeholder="Enter description to update..."></textarea>
    </div>

    <!-- Update and Clear Buttons -->
    <div class="action-buttons">
      <button class="clear-all-btn" (click)="clearAll()">Clear All</button>
      <button class="update-btn" 
        (click)="updateComputerDescription()" 
        [disabled]="!selectedTargetComputer() || isUpdating()">
        {{ isUpdating() ? 'Updating...' : 'Update Description' }}
      </button>
    </div>

    <!-- Status Message -->
    @if (updateMessage()) {
    <div class="message" [class.success]="updateMessage().includes('successfully')" 
         [class.error]="updateMessage().includes('Error')">
      {{ updateMessage() }}
    </div>
    }
  </div>
  }

  <!-- Last Device Tab -->
  @if (activeTab() === 'last-device') {
  <div class="tab-content last-device-content">
    @if (lastDevicesLoading()) {
    <div class="loading">Loading last device numbers...</div>
    } @else if (lastDevicesLoaded()) {
    <div class="devices-display">
      <h3>Next Device Name</h3>
      <div class="devices-grid">
        @for (prefix of ['SDLL', 'SDLD', 'DBOL']; track prefix) {
        <div class="device-card">
          <div class="device-prefix">{{ prefix }}</div>
          <div class="device-number">{{ (lastDevices()[prefix] + + 1).toString().padStart(3, '0') }}</div>
          <div class="next-number">Last: {{ prefix }}{{ lastDevices()[prefix]  }}</div>
        </div>
        }
      </div>
    </div>
    } @else {
    <div class="no-data">Click Load to fetch the latest device numbers</div>
    }
  </div>
  }

  <!-- Update User Tab -->
  @if (activeTab() === 'update-user') {
  <div class="tab-content update-user-content">
    <h2>Update User Info (XLSX)</h2>

    <div class="upload-row">
      <div class="upload-left">
        <input id="fileInput" type="file" (change)="onFileSelected($any($event))" accept=".xlsx" />
        <label class="upload-btn" for="fileInput">Upload XLSX</label>
        @if (fileName()) {
        <div class="file-name">{{ fileName() }}</div>
        }
      </div>

      @if (rows().length > 0) {
      <div class="upload-actions">
        <button class="btn btn-success" (click)="preparePreview()" [disabled]="isBulkUpdating() || rows().length === 0">Preview Changes</button>
        <button class="btn btn-danger" (click)="clearBulkUpdate()" [disabled]="isBulkUpdating() || rows().length === 0">Clear</button>
      </div>
      }
    </div>

    @if (headerError()) {
    <div class="error">{{ headerError() }}</div>
    }
    @if (rowLimitError()) {
    <div class="error">{{ rowLimitError() }}</div>
    }

    @if (rows().length > 0) {
    <div class="preview">
      <h3>Preview (first 100 rows)</h3>
      <table>
        <thead>
          <tr><th>UPN</th><th>Department</th><th>Title</th><th>Manager</th></tr>
        </thead>
        <tbody>
          @for (row of rows().slice(0,100); track $index) {
          <tr>
            <td>{{ row.upn }}</td>
            <td>{{ row.department }}</td>
            <td>{{ row.title }}</td>
            <td>{{ row.manager }}</td>
          </tr>
          }
        </tbody>
      </table>

      <div class="actions">
        <button class="btn btn-success" (click)="preparePreview()" [disabled]="isBulkUpdating()">Preview Changes</button>
        <button class="btn btn-danger" (click)="clearBulkUpdate()" [disabled]="isBulkUpdating()">Clear</button>
        <div class="progress">{{ bulkProgress() }}</div>
      </div>
    
      @if (showPreviewModal()) {
      <div class="modal-overlay" (click)="showPreviewModal.set(false)">
        <div class="modal" (click)="$any($event).stopPropagation()">
          <button class="modal-close" (click)="showPreviewModal.set(false)">✕</button>
          <h2>Preview Changes ({{ previewRows().length }})</h2>
          <div class="preview-list">
            <table>
              <thead><tr><th>UPN</th><th>Dept</th><th>Title</th><th>Manager</th></tr></thead>
              <tbody>
                @for (r of previewRows().slice(0,200); track $index) {
                <tr>
                  <td>{{ r.upn }}</td>
                  <td>{{ r.department }}</td>
                  <td>{{ r.title }}</td>
                  <td>{{ r.manager }}</td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          <div class="modal-actions">
            <button class="btn btn-success" (click)="startUpdates()">Apply Updates</button>
            <button class="btn" (click)="showPreviewModal.set(false)">Cancel</button>
          </div>
        </div>
      </div>
      }
    </div>
    }

    @if (showFailedModal()) {
    <div class="modal-overlay" (click)="closeFailedModal()">
      <div class="modal" (click)="$any($event).stopPropagation()">
        <button class="modal-close" (click)="closeFailedModal()">✕</button>
        <h2>Failed Updates ({{ failedRows().length }})</h2>
        <div class="failed-list">
          <table>
            <thead><tr><th>UPN</th><th>Department</th><th>Title</th><th>Manager</th><th>Error</th></tr></thead>
            <tbody>
              @for (f of failedRows(); track $index) {
              <tr>
                <td>{{ f.upn }}</td>
                <td>{{ f.department }}</td>
                <td>{{ f.title }}</td>
                <td>{{ f.manager }}</td>
                <td>{{ f.error }}</td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="modal-actions">
          <button class="btn" (click)="downloadFailedXlsx()">Download Failed XLSX</button>
          <button class="btn" (click)="closeFailedModal()">Close</button>
        </div>
      </div>
    </div>
    }

    @if (showSuccessModal()) {
    <div class="modal-overlay" (click)="showSuccessModal.set(false)">
      <div class="modal" (click)="$any($event).stopPropagation()">
        <button class="modal-close" (click)="showSuccessModal.set(false)">✕</button>
        <h2>All updates applied successfully</h2>
        <div class="modal-actions">
          <button class="btn btn-success" (click)="closeSuccessAndClear()">OK</button>
        </div>
      </div>
    </div>
    }
    
    <div class="info-text">
      <h3>Column heading: UPN, Department, Title, Manager</h3>
      <p>UPN = email address</p>
      <p>Job Title = Description, so no need to add another column in excel file.</p>
      <p>Manager = exact display name according to MS team (Example: "Mustafa, Nurul")</p>
      <p>This will update Department, Job Title, Description, and Manager fields in AD</p>
    </div>
  </div>
  }
</div>